flowchart TD
    START([开始]) --> INPUT{输入类型}
    
    INPUT -->|单文件| SINGLE[单文件处理]
    INPUT -->|批量文件| BATCH[批量文件处理]
    INPUT -->|文本字符串| TEXT[文本处理]
    
    SINGLE --> VALIDATE[文件验证]
    BATCH --> LOOP[循环处理]
    TEXT --> PARSE[解析处理]
    
    LOOP --> VALIDATE
    VALIDATE -->|验证失败| ERROR[错误处理]
    VALIDATE -->|验证成功| PARSE[Markdown解析]
    
    ERROR --> LOG[记录日志]
    LOG --> NOTIFY[用户通知]
    NOTIFY --> END([结束])
    
    PARSE --> AST[构建语法树]
    AST --> PROCESS[内容处理]
    
    PROCESS --> TEXTCONV[文本转换]
    PROCESS --> HEADERCONV[标题转换]
    PROCESS --> LISTCONV[列表转换]
    PROCESS --> TABLECONV[表格转换]
    PROCESS --> IMGCONV[图片转换]
    PROCESS --> CODECONV[代码转换]
    PROCESS --> LINKCONV[链接转换]
    PROCESS --> MATHCONV[公式转换]
    
    TEXTCONV --> MERGE[内容合并]
    HEADERCONV --> MERGE
    LISTCONV --> MERGE
    TABLECONV --> MERGE
    IMGCONV --> IMGPROCESS[图片处理]
    CODECONV --> MERGE
    LINKCONV --> MERGE
    MATHCONV --> MERGE
    
    IMGPROCESS -->|下载网络图片| DOWNLOAD[图片下载]
    IMGPROCESS -->|处理本地图片| RESIZE[图片调整]
    DOWNLOAD --> RESIZE
    RESIZE --> MERGE
    
    MERGE --> APPLYSTYLE[应用样式]
    APPLYSTYLE --> TEMPLATE[模板应用]
    TEMPLATE --> DOCGEN[Word文档生成]
    
    DOCGEN --> OPTIMIZE[文档优化]
    OPTIMIZE --> VALIDATE_OUTPUT[输出验证]
    
    VALIDATE_OUTPUT -->|验证失败| FIX[错误修复]
    VALIDATE_OUTPUT -->|验证成功| SAVE[保存文件]
    
    FIX --> DOCGEN
    SAVE --> CLEANUP[清理临时文件]
    CLEANUP --> SUCCESS[转换成功]
    SUCCESS --> END
    
    %% 并行处理分支
    BATCH --> PARALLEL{并行处理?}
    PARALLEL -->|是| THREAD[多线程处理]
    PARALLEL -->|否| SEQUENTIAL[顺序处理]
    
    THREAD --> WORKER1[工作线程1]
    THREAD --> WORKER2[工作线程2] 
    THREAD --> WORKER3[工作线程N]
    
    WORKER1 --> VALIDATE
    WORKER2 --> VALIDATE
    WORKER3 --> VALIDATE
    
    SEQUENTIAL --> VALIDATE
    
    %% 错误恢复流程
    ERROR --> RETRY{可重试?}
    RETRY -->|是| RETRY_COUNT[重试计数]
    RETRY -->|否| FAIL[转换失败]
    
    RETRY_COUNT -->|< 最大重试| PARSE
    RETRY_COUNT -->|>= 最大重试| FAIL
    
    FAIL --> CLEANUP
    
    %% 样式定义
    classDef startEnd fill:#4caf50,stroke:#2e7d32,color:#fff
    classDef process fill:#2196f3,stroke:#1565c0,color:#fff
    classDef decision fill:#ff9800,stroke:#ef6c00,color:#fff
    classDef error fill:#f44336,stroke:#c62828,color:#fff
    classDef success fill:#8bc34a,stroke:#558b2f,color:#fff
    
    class START,END startEnd
    class SINGLE,BATCH,TEXT,VALIDATE,PARSE,AST,PROCESS,TEXTCONV,HEADERCONV,LISTCONV,TABLECONV,IMGCONV,CODECONV,LINKCONV,MATHCONV,MERGE,APPLYSTYLE,TEMPLATE,DOCGEN,OPTIMIZE,SAVE,CLEANUP,IMGPROCESS,DOWNLOAD,RESIZE,THREAD,WORKER1,WORKER2,WORKER3,SEQUENTIAL process
    class INPUT,PARALLEL,RETRY,VALIDATE_OUTPUT decision
    class ERROR,LOG,NOTIFY,FIX,FAIL error
    class SUCCESS success