# 图表插入实现方案

## 一、数据流程

1. **LLM识别数据**：分析Markdown文本，识别需要制作饼图的数据，返回JSON格式
2. **生成图片**：调用饼图生成函数，根据JSON数据生成PNG图片
3. **插入Word**：根据position字段定位插入点，将饼图插入到Word文档

### 饼图插入位置规则

饼图插入位置相对固定，常见场景：
- 在"一、短信告警情况汇总"等章节标题后的数据描述段落之后
- 在包含占比数据的段落之后，如："系统告警占比61.76%，硬件告警占比38.24％"
- 在"硬件监控告警"、"系统告警"等关键词所在段落之后
- 在包含具体分布数据的段落之后，如："容量超过阈值告警4起，设备状态异常告警4起..."

## 二、LLM数据格式

### 输入
Markdown文本内容

### 输出JSON结构
```json
{
  "charts": [
    {
      "type": "pie",
      "title": "图表标题",
      "position": "after:关键词文本",
      "data": {
        "标签1": 数值1,
        "标签2": 数值2
      }
    }
  ]
}
```

### position字段规则
- `after:文本` - 在该文本所在段落后插入（主要使用此模式）
- 常见关键词：章节标题、占比描述、分布数据描述等

## 三、图表生成

### 函数接口
基于`docs/ccc.py`封装为函数：
- 输入：标题、数据字典、颜色列表（可选）
- 输出：PNG图片文件路径

### 处理逻辑
1. 仅支持饼图类型（type必须为"pie"）
2. 使用ccc.py的样式（图例在右侧、百分比黑色背景、2D平面效果）
3. 设置中文字体、标题、配色
4. 保存为PNG，300 DPI，宽度14cm
5. 返回图片文件路径

## 四、Word插入

### 位置定位
1. 遍历Word文档所有段落
2. 根据position字段匹配文本
3. 匹配策略：精确匹配 → 模糊匹配 → 段落索引 → 文档末尾

### 插入操作
- **after模式**：在匹配段落后插入新段落，添加饼图图片

### 图片设置
- 宽度：14cm
- 居中显示
- 可选：添加图表标题段落（居中）

## 五、集成点

### 在WordGenerator中
1. 在`convert`方法开始前调用LLM识别饼图数据
2. 遍历识别结果，生成所有饼图图片
3. 在生成Word过程中，遇到匹配position的段落时插入对应饼图
4. 生成完成后清理临时图片文件

### 错误处理
- LLM返回格式错误：跳过图表生成
- 图片生成失败：记录错误，继续处理
- 位置匹配失败：插入到文档末尾

## 六、配置参数

- `enable_charts`: 是否启用图表生成（默认true）
