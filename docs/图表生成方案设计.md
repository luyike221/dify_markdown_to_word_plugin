# 图表生成方案设计（核心版）

## 一、核心流程

```
Markdown文本
    ↓
LLM识别需要制作图表的数据
    ↓
提取结构化数据（JSON）
    ↓
生成图表图片（PNG）
    ↓
插入Word文档指定位置
```

## 二、LLM数据识别

### 2.1 识别Prompt

```
请分析以下Markdown文本，识别其中需要制作图表的数据：

{markdown_text}

请识别：
1. 占比数据（如：17.4%、27.6%）
2. 分布数据（如：系统A占27.6%，系统B占31.0%）
3. 时段数据（如：04:00-06:00有15条告警）
4. 对比数据（如：不同系统的告警数量）

返回JSON格式：
{
  "charts": [
    {
      "type": "pie|bar|line",
      "title": "图表标题",
      "position": "after:告警主要集中在",  // 插入位置标识
      "data": {
        "分布式技术平台": 27.6,
        "海量数据处理平台": 31.0,
        "审计信息系统": 10.3
      }
    }
  ]
}
```

### 2.2 返回示例

**输入文本：**
```
告警主要集中在分布式技术平台（27.6%）、海量数据处理平台（31.0%）及审计信息系统（10.3%）。
告警时段集中在凌晨04:00-06:00及业务高峰时段14:00-16:00。
```

**LLM返回：**
```json
{
  "charts": [
    {
      "type": "pie",
      "title": "告警系统分布",
      "position": "after:告警主要集中在",
      "data": {
        "分布式技术平台": 27.6,
        "海量数据处理平台": 31.0,
        "审计信息系统": 10.3,
        "其他": 31.1
      }
    },
    {
      "type": "bar",
      "title": "告警时段分布",
      "position": "after:告警时段集中在",
      "data": {
        "04:00-06:00": 15,
        "14:00-16:00": 12,
        "其他时段": 2
      }
    }
  ]
}
```

## 三、图表图片生成

### 3.1 技术选型
- **图表库**：Matplotlib
- **图片格式**：PNG
- **分辨率**：300 DPI（打印质量）
- **尺寸**：宽度14cm，高度根据数据自适应（约8-12cm）

### 3.2 生成步骤

#### 步骤1：创建图表
```python
import matplotlib.pyplot as plt
import matplotlib
matplotlib.rcParams['font.sans-serif'] = ['SimHei']  # 支持中文
matplotlib.rcParams['axes.unicode_minus'] = False

# 根据类型创建图表
if chart_type == "pie":
    # 饼图
    plt.pie(data.values(), labels=data.keys(), autopct='%1.1f%%')
elif chart_type == "bar":
    # 柱状图
    plt.bar(data.keys(), data.values())
elif chart_type == "line":
    # 折线图
    plt.plot(data.keys(), data.values())
```

#### 步骤2：应用样式
- 从主题配置读取配色方案
- 设置标题、标签、图例
- 调整字体大小和样式

#### 步骤3：保存图片
```python
# 设置图片尺寸（14cm宽，约530像素@300DPI）
fig = plt.figure(figsize=(14/2.54, height/2.54), dpi=300)
# ... 绘制图表 ...
plt.savefig('chart.png', dpi=300, bbox_inches='tight', 
            facecolor='white', transparent=False)
plt.close()
```

### 3.3 样式配置

从主题配置读取：
```yaml
chart:
  colors: ["#d32f2f", "#ff9800", "#2196f3", "#4caf50"]  # 主题配色
  font_size: 12
  title_font_size: 14
```

## 四、插入Word指定位置

### 4.1 位置标识方案

#### 方案A：文本锚点（推荐）
LLM返回的`position`字段包含位置标识：
- `"after:告警主要集中在"` - 在该文本后插入
- `"before:告警清单"` - 在该文本前插入
- `"replace:告警主要集中在...审计信息系统"` - 替换该段文本

#### 方案B：Markdown标记
在Markdown中使用特殊标记：
```markdown
告警主要集中在分布式技术平台（27.6%）、海量数据处理平台（31.0%）。

[CHART:pie:告警系统分布]

告警时段集中在凌晨04:00-06:00。
```

### 4.2 插入实现

#### 步骤1：定位插入点
```python
# 在Word文档中查找位置标识文本
for paragraph in document.paragraphs:
    if "告警主要集中在" in paragraph.text:
        # 找到插入位置
        insert_position = paragraph
        break
```

#### 步骤2：插入图片
```python
from docx.shared import Cm

# 在指定段落后插入图片
run = insert_position.add_run()
run.add_picture('chart.png', width=Cm(14))

# 添加图表标题
title_para = document.add_paragraph("图1: 告警系统分布")
title_para.alignment = WD_ALIGN_PARAGRAPH.CENTER
```

#### 步骤3：处理替换场景
```python
# 如果position是replace，删除原文本段落
if position_type == "replace":
    # 删除原段落
    paragraph.clear()
    # 插入图表
    run = paragraph.add_run()
    run.add_picture('chart.png', width=Cm(14))
```

### 4.3 位置匹配策略

1. **精确匹配**：查找完全匹配的文本
2. **模糊匹配**：查找包含关键词的段落
3. **段落索引**：如果找不到，使用段落序号
4. **默认位置**：如果都找不到，插入到文档末尾

## 五、完整示例

### 输入Markdown
```markdown
## 告警分析

10月CPU类告警共29条，占总告警量17.4%。

告警主要集中在分布式技术平台（27.6%）、海量数据处理平台（31.0%）及审计信息系统（10.3%）。

告警时段集中在凌晨04:00-06:00及业务高峰时段14:00-16:00。
```

### LLM识别结果
```json
{
  "charts": [
    {
      "type": "pie",
      "title": "告警系统分布",
      "position": "after:告警主要集中在分布式技术平台",
      "data": {
        "分布式技术平台": 27.6,
        "海量数据处理平台": 31.0,
        "审计信息系统": 10.3,
        "其他": 31.1
      }
    },
    {
      "type": "bar",
      "title": "告警时段分布",
      "position": "after:告警时段集中在",
      "data": {
        "04:00-06:00": 15,
        "14:00-16:00": 12,
        "其他时段": 2
      }
    }
  ]
}
```

### 处理流程
1. **识别**：LLM识别出2个图表需求
2. **生成**：
   - 生成饼图：告警系统分布（PNG，14cm宽）
   - 生成柱状图：告警时段分布（PNG，14cm宽）
3. **插入**：
   - 饼图插入到"告警主要集中在..."段落之后
   - 柱状图插入到"告警时段集中在..."段落之后
4. **结果**：Word文档中在对应位置显示图表

## 六、技术要点

### 6.1 图片生成
- 使用Matplotlib生成高质量PNG图片
- 支持中文显示（设置中文字体）
- 应用主题配色方案
- 自动调整图表尺寸

### 6.2 位置定位
- 通过文本匹配定位插入点
- 支持before/after/replace三种插入方式
- 处理找不到匹配文本的情况（降级策略）

### 6.3 性能优化
- 图片缓存：相同数据不重复生成
- 批量处理：一次生成多个图表
- 临时文件管理：生成后及时清理

## 七、配置参数

在工具参数中添加：

```yaml
- name: enable_auto_charts
  type: boolean
  default: true
  label:
    zh_Hans: 自动生成图表
  description: "使用LLM识别数据并自动生成图表"

- name: chart_width
  type: number
  default: 14
  label:
    zh_Hans: 图表宽度(厘米)
  description: "图表在Word中的显示宽度"
```
